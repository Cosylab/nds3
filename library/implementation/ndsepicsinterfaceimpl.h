#ifndef NDSEPICSINTERFACEIMPL_H
#define NDSEPICSINTERFACEIMPL_H

#include <asynPortDriver.h>
#include <string>
#include <vector>
#include "ndspvbaseimpl.h"
#include "ndsinterfacebaseimpl.h"

namespace nds
{

class PVBase;

/**
 * @internal
 * @brief The AsynInterface class. Allocated by AsynPort
 *        to communicate with the AsynDriver
 */
class EpicsInterfaceImpl: public InterfaceBaseImpl, asynPortDriver
{
public:
    EpicsInterfaceImpl(const std::string& portName);

    virtual void registerPV(std::shared_ptr<PVBaseImpl> pv);

    virtual void registrationTerminated();

    virtual void push(const timespec& timestamp, const pvList_t& pvList);

    virtual asynStatus readInt32(asynUser *pasynUser, epicsInt32 *value);
    virtual asynStatus writeInt32(asynUser *pasynUser, epicsInt32 value);

    virtual asynStatus readFloat64(asynUser *pasynUser, epicsFloat64 *value);
    virtual asynStatus writeFloat64(asynUser *pasynUser, epicsFloat64 value);

    virtual asynStatus readInt32Array(asynUser *pasynUser, epicsInt32 *value,
                                                  size_t nElements, size_t *nIn);
    virtual asynStatus writeInt32Array(asynUser *pasynUser, epicsInt32 *value,
                                                   size_t nElements);

    virtual asynStatus drvUserCreate(asynUser *pasynUser, const char *drvInfo,
                                     const char **pptypeName, size_t *psize);

    timespec convertEpicsTimeToUnixTime(const epicsTimeStamp& time);
    epicsTimeStamp convertUnixTimeToEpicsTime(const timespec& time);

private:
    std::vector<std::shared_ptr<PVBaseImpl> > m_pvs;

    std::string m_autogeneratedDB;
};

}

#endif // NDSEPICSINTERFACEIMPL_H
